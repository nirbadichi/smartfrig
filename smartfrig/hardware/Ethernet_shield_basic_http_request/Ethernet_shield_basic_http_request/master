// Master Code (Nano)
#include <SoftwareSerial.h>
#include <SPI.h>
#include <Wire.h>
#include <PN532_I2C.h>
#include <PN532.h>
#include <NfcAdapter.h>

//==========================================
// NFC defines
//==========================================
PN532_I2C pn532_i2c(Wire);
NfcAdapter nfc = NfcAdapter(pn532_i2c);

//==========================================
// General defines
//==========================================
#define DEBUG_MODE 1


void nfcSetup()
{
    //Initialize nfc serial
    nfc.begin();
    Serial.println("NDEF Reader");
    delay(500);
}

void wireSetup()
{
    Wire.begin();    
  delay(500);
}

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  pinMode(4,OUTPUT);
  digitalWrite(4,LOW);

  nfcSetup();
  wireSetup();

}

void loop() {
  if (DEBUG_MODE){
      Serial.println("\nScan a NFC tag\n");
  }
  if (nfc.tagPresent()){
      NfcTag tag = nfc.read();
      if (tag.hasNdefMessage()){ // every tag won't have a message
          digitalWrite(4,HIGH);
          String payloadAsString = "";
          NdefMessage message = tag.getNdefMessage();
          int recordCount = message.getRecordCount();
          for (int i = 0; i < recordCount; i++){      
              NdefMessage message = tag.getNdefMessage();
              NdefRecord record = message.getRecord(i);
              int payloadLength = record.getPayloadLength();
              byte payload[payloadLength];
              record.getPayload(payload);
              for (int c = 0; c < payloadLength; c++) {
                  payloadAsString += (char)payload[c];
              }
              if (DEBUG_MODE)
              {
                  Serial.println(payloadAsString);
              }
              
          }
          Wire.beginTransmission(5);
          Serial.println("sending String:");
          char tab2[1024];
          strncpy(tab2, payloadAsString.c_str(), sizeof(tab2));
          tab2[sizeof(tab2) - 1] = 0;
          Wire.write(tab2);
          Wire.endTransmission();
          Serial.println("data was sent");
          delay(1000);
          if (DEBUG_MODE)
          {
             Wire.requestFrom(5,5);
          }
          while (Wire.available()){
            char c = Wire.read();
            Serial.print(c);
          }
          digitalWrite(4,LOW);
      }    
  }
  delay(3000);
}



