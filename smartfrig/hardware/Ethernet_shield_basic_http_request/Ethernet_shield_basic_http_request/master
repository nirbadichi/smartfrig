// Master Code (Nano)
#include <SoftwareSerial.h>
#include <SPI.h>
#include <Wire.h>
#include <PN532_I2C.h>
#include <PN532.h>
#include <NfcAdapter.h>

//==========================================
// NFC defines
//==========================================
PN532_I2C pn532_i2c(Wire);
NfcAdapter nfc = NfcAdapter(pn532_i2c);

//==========================================
// General defines
//==========================================
#define DEBUG_MODE 1


void nfcSetup()
{
    //Initialize nfc serial
    nfc.begin();
    Serial.println("NDEF Reader");
}

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  pinMode(4,OUTPUT);
  digitalWrite(4,LOW);
 delay(500);
  nfcSetup();
  delay(500);
   Wire.begin();    
  delay(500);

}

void loop() {
delay(1000);
  if (DEBUG_MODE){
      Serial.println("\nScan a NFC tag\n");
  }
  if (nfc.tagPresent()){
      NfcTag tag = nfc.read();
      if (tag.hasNdefMessage()){ // every tag won't have a message
          delay(50);
	  digitalWrite(4,HIGH);
          delay(500);
          String payloadAsString = "";
          NdefMessage message = tag.getNdefMessage();
          int recordCount = message.getRecordCount();   
              NdefRecord record = message.getRecord(0);
              int payloadLength = record.getPayloadLength();
              byte payload[payloadLength];
              record.getPayload(payload);
              for (int c = 0; c < payloadLength; c++) {
                  payloadAsString += (char)payload[c];
              }
              if (DEBUG_MODE)
              {
                  Serial.println(payloadAsString);
              }
              
          delay(500);
          Wire.beginTransmission(5);
          Serial.println("sending String:");
          /*char tab2[1024];
          strncpy(tab2, payloadAsString.c_str(), sizeof(tab2));
          tab2[sizeof(tab2) - 1] = 0;
          Wire.write(tab2);*/
          Wire.write(payloadAsString.c_str(),payloadAsString.length());
//          Wire.write("2;2;2;2;2;2;2;2");
          Wire.endTransmission();
          Serial.println("data was sent");
          delay(200);
         /* if (DEBUG_MODE)
          {
             Wire.requestFrom(5,payloadAsString.length());
             delay(100);
          }*/
          while (Wire.available()){
            char c = Wire.read();
            Serial.print(c);
          }
          digitalWrite(4,LOW);
      }    
  }
  delay(3000);
}
