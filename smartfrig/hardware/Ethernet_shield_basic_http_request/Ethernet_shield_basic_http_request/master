// Master Code (Nano)
#include <SoftwareSerial.h>
#include <SPI.h>
#include <Wire.h>
#include <PN532_I2C.h>
#include <PN532.h>
#include <NfcAdapter.h>

//==========================================
// NFC defines
//==========================================
PN532_I2C pn532_i2c(Wire);
NfcAdapter nfc = NfcAdapter(pn532_i2c);

//==========================================
// General defines
//==========================================
#define DEBUG_MODE 1


void nfcSetup()
{
    //Initialize nfc serial
    nfc.begin();
    Serial.println("NDEF Reader");
}

void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);
  pinMode(4,OUTPUT);
 // digitalWrite(3,0);
  delay(500);
  nfcSetup();
   delay(500);
  //digitalWrite(4,HIGH);
  //delay(500);
  Wire.begin();    
  delay(500);

}

void loop() {
  /*digitalWrite(4,0);
  delay(1000);
   digitalWrite(4,1);
   delay(1000);
  digitalWrite(3,0);
  delay(50);*/
  if (DEBUG_MODE){
      Serial.println("\nScan a NFC tag\n");
  }
  //digitalWrite(2,0);
  if (nfc.tagPresent()){
      NfcTag tag = nfc.read();
      if (tag.hasNdefMessage()){ // every tag won't have a message
          String payloadAsString = "";
          NdefMessage message = tag.getNdefMessage();
          int recordCount = message.getRecordCount();
          for (int i = 0; i < recordCount; i++){      
              NdefMessage message = tag.getNdefMessage();
              NdefRecord record = message.getRecord(i);
              int payloadLength = record.getPayloadLength();
              byte payload[payloadLength];
              record.getPayload(payload);
              for (int c = 0; c < payloadLength; c++) {
                  payloadAsString += (char)payload[c];
              }
              if (DEBUG_MODE)
              {
                  Serial.println(payloadAsString);
              }
              
          }
          digitalWrite(3,HIGH);
          delay(50);
          digitalWrite(3,LOW);
          delay(50);
          digitalWrite(3,HIGH);
          delay(500);
          Wire.begin();
          delay(500);
          Wire.beginTransmission(5);
          Serial.println("sending String:");
          Wire.write("2;2;2;2;2;1;1;1");
          Wire.endTransmission();
          Serial.println("data was sent");
          delay(1000);
          Wire.requestFrom(5,5);
          while (Wire.available()){
            char c = Wire.read();
            Serial.print(c);
          }
      }    
  }
  delay(3000);
  /*
  // put your main code here, to run repeatedly:
  while(Serial.available()){
      char c =Serial.read();
      if(c == 'H'){
       // digitalWrite(2,0);
        delay(50);
        Serial.println("start sending");
        Wire.beginTransmission(5);
        Wire.write("1;1;1;1;1;1;1;1");
        Wire.endTransmission();
        delay(10000);
        Wire.requestFrom(5,5);
               Serial.println("requset");
        while (Wire.available()){
            char c = Wire.read();
            Serial.print(c);
        }
      }
  }*/
        
}



